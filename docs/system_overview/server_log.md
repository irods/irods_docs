#

## The Server Log

The server log file is managed by syslog. When unexpected behavior occurs, inspecting the log file is the first place that should be checked. By default, log messages for iRODS will appear in **/var/log/syslog**.

Having log messages for iRODS appear among log messages from other applications is probably not desirable. Because iRODS uses syslog for logging, this can be changed.

Because there are multiple implementations of syslog, iRODS does not declare any dependencies on a specific implementation of syslog. However, basic configurations for [rsyslog](#rsyslog-configuration) and [logrotate](#logrotate-configuration) have been provided as a convenience.

### rsyslog configuration

!!! Important
    If upgrading to iRODS 5.0.0 and using rsyslog, you'll need to add **irodsAgent** to your rsyslog configuration. Failing to do so will result in important log messages not being written to the log file.

The key points to remember about the following configuration are:

- The log file, **/var/log/irods/irods.log**, will be readable by anyone with access to the OS
- All messages generated by any process whose name starts with **irodsServer** will be written to the log file
- All messages generated by any process whose name starts with **irodsDelayServer** will be written to the log file
- All messages generated by any process whose name starts with **irodsAgent** will be written to the log file

```text
# file: /etc/rsyslog.d/00-irods.conf

$FileCreateMode 0644
$DirCreateMode 0755
$Umask 0000
$template irods_format,"%msg%\n"
:programname,startswith,"irodsServer" /var/log/irods/irods.log;irods_format
& stop
:programname,startswith,"irodsDelayServer" /var/log/irods/irods.log;irods_format
& stop
:programname,startswith,"irodsAgent" /var/log/irods/irods.log;irods_format
& stop
```

### logrotate configuration

The key points to remember about the following configuration are:

- The log file, **/var/log/irods/irods.log**, will be rotated weekly
- The log file will be rotated 26 times before being removed
- The log file will be compressed in gzip format

```text
# file: /etc/logrotate.d/irods

/var/log/irods/irods.log {
    weekly
    rotate 26
    copytruncate
    delaycompress
    compress
    dateext
    notifempty
    missingok
    su root root
}
```

Other implementations of syslog can be used, but that is out of scope of this documentation.

### Log Message Structure

Each line within the log file is formatted as JSON. The following properties are guaranteed to exist:
```json
{
    // The server component that generated the message (e.g. "rule_engine", "database", "api", etc).
    "log_category": string,

    // The severity of the message.
    //
    // This will be one of the following:
    // - trace
    // - debug
    // - info
    // - warn
    // - error
    // - critical
    "log_level": string,

    // The message detailing what actually happened within the server.
    "log_message": string,

    // The iRODS server that generated the message.
    "server_host": string,

    // The PID of the process that generated the message.
    "server_pid": integer,

    // The time when the message was generated.
    "server_timestamp": string,

    // The type of process that generated the message.
    //
    // This will be one of the following:
    // - server
    // - agent_factory
    // - agent
    // - delay_server
    "server_type": string,

    // The name of the zone the server is a member of.
    "server_zone": string
}
```

In addition to those, the following properties will be included if available:
```json
{
    // The human-readable name of the API operation.
    "request_api_name": string,

    // The integer value that identifies the API operation.
    "request_api_number": integer,

    // The API version of the iRODS client which sent the request (e.g. "d").
    "request_api_version": string,

    // The iRODS user who sent the API request.
    "request_client_user": string,

    // The IP or hostname of the client which sent the API request.
    "request_host": string,

    // The proxy iRODS user carrying out the operation on behalf of "request_client_user".
    "request_proxy_user": string,

    // The version of the iRODS client which sent the request (e.g. "rods4.3.0").
    "request_release_version": string
}
```

If an operation results in a program crash and a stacktrace is generated, the following properties will be included if available:
```json
{
    // The PID of the iRODS agent that crashed and generated the stacktrace.
    "stacktrace_agent_pid": integer,

    // The time when the crash occurred in UTC.
    "stacktrace_timestamp_utc": string,

    // The time when the crash occurred (seconds since epoch only).
    "stacktrace_timestamp_epoch_seconds": integer,

    // The time when the crash occurred (partial seconds since epoch only).
    // This property is meant to be paired with "stacktrace_timestamp_epoch_seconds".
    "stacktrace_timestamp_epoch_milliseconds": integer
}
```

## Log Categories and Levels

Log output is managed via **server_config.json**. The server provides several log categories in regards to log output. This gives administrators the ability to choose different log levels for various components in an iRODS server. To do this, open **server_config.json** and find the **log_level** property. It should have the following structure:
```json
{
    // ... Other configuration properties ...

    "log_level": {
        // Controls log output related to generic Agent operations.
        "agent": "info",

        // Controls log output related to the Agent Factory process.
        "agent_factory": "info",

        // Controls log output related to API operations.
        "api": "info",

        // Controls log output related to authentication operations.
        "authentication": "info",

        // Controls log output related to database operations.
        "database": "info",

        // Controls log output related to the Delay Server process.
        "delay_server": "info",

        // Controls log output related to the GenQuery1 parser.
        // This log category DOES NOT affect the log output of the GenQuery1 API.
        // The GenQuery1 API log output is controlled via the "api" log category.
        "genquery1": "info",

        // Controls log output related to the GenQuery2 parser.
        // This log category DOES NOT affect the log output of the GenQuery2 API.
        // The GenQuery2 API log output is controlled via the "api" log category.
        "genquery2": "info",

        // Controls log output recorded via the rodsLog API.
        "legacy": "info",

        // Controls log output related to microservice operations.
        "microservice": "info",

        // Controls log output related to networking operations.
        "network": "info",

        // Controls log output related to resource operations.
        "resource": "info",

        // Controls log output related to rule engine plugin operations.
        "rule_engine": "info",

        // Controls log output related to the iRODS process overseeing all other
        // iRODS processes.
        "server": "info",

        // Controls log output related to SQL.
        "sql": "info"
    },

    // ... Other configuration properties ...
}
```

Each category can be set to one of the following values (ordered from most verbose to least verbose):

- trace
- debug
- info
- warn
- error
- critical

While the logging infrastructure has been modernized, use of it has not yet been applied throughout the iRODS server. This means that the **legacy** log category will be the primary setting for controlling log output (**rodsLog** API output is controlled by the **legacy** log category). This situation will improve with future releases.
